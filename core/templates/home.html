{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NATURAL HOME</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- HEADER -->
    <header class="top-header">
        <div class="logo">NATURAL HOME</div>
        <div class="header-actions">
            <a href="{% url 'admin_products' %}" class="btn-admin">
                <i class="fas fa-user-cog"></i> Admin
            </a>
            <button class="btn-cart" id="btnAbrirCarrito">
                <i class="fas fa-shopping-cart"></i> Carrito <span id="carritoCount">0</span>
            </button>
        </div>
    </header>

    <!-- SUPER DESCUENTOS -->
    <div class="super-desc"><i class="fas fa-fire"></i> SUPER DESCUENTOS DE NATURAL HOME</div>

    <!-- CARRUSEL DE PRODUCTOS CON DESCUENTO -->
    {% if productos_descuento %}
    <div class="carrusel-descuentos">
        <div class="carrusel-container">
            <button class="carrusel-btn prev" onclick="moveCarousel(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>

            <div class="carrusel-track" id="carruselTrack">
                {% for p in productos_descuento %}
                <div class="carrusel-slide">
                    <div class="card-carrusel">
                        <div class="card-carrusel-image">

                            <!-- Botón agregar al carrito -->
                            <button class="btn-add-to-cart-icon"
                                    onclick="agregarAlCarrito({{ p.id }}, '{{ p.titulo|escapejs }}', {{ p.precio_con_descuento }})">
                                <i class="fas fa-cart-plus"></i>
                            </button>

                            <img src="{{ p.imagen.url }}" class="img-producto-carrusel"
                                 alt="{{ p.titulo }}" onerror="this.src='{% static 'img/no-image.png' %}'">

                            <div class="badge-descuento-carrusel">-{{ p.porcentaje_descuento }}%</div>
                        </div>

                        <div class="card-carrusel-content">
                            <h4>{{ p.titulo }}</h4>

                            <div class="card-carrusel-pricing">
                                <div class="pricing-with-discount-carrusel">
                                    <div class="original-price-carrusel">${{ p.precio }}</div>
                                    <div class="current-price-carrusel">${{ p.precio_con_descuento }}</div>
                                </div>

                                <div class="product-unit-carrusel">
                                    <span class="unit-badge-carrusel">{{ p.get_unidad_display }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button class="carrusel-btn next" onclick="moveCarousel(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="carrusel-dots" id="carruselDots"></div>
    </div>
    {% endif %}

    <!-- BUSCADOR + FILTROS -->
    <div class="filtros">
        <form method="get" class="search-form" id="searchForm">
            <div class="search-wrapper">
                <input type="text" name="q" value="{{ query|default_if_none:'' }}"
                       id="searchInput" placeholder="Buscar productos..." onkeyup="buscarProductos()">

                <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>

                {% if query %}
                <a href="{% url 'home' %}" class="search-clear" title="Limpiar búsqueda">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </div>
        </form>

        <div class="filter-buttons">
            <button onclick="filtrar('todas')" class="filter-btn {% if not categoria_actual %}active{% endif %}">
                Todas
            </button>

            <button onclick="filtrar('verduras')" class="filter-btn {% if categoria_actual == 'verduras' %}active{% endif %}">
                Verduras
            </button>

            <button onclick="filtrar('frutas')" class="filter-btn {% if categoria_actual == 'frutas' %}active{% endif %}">
                Frutas
            </button>

            <button onclick="filtrar('otros')" class="filter-btn {% if categoria_actual == 'otros' %}active{% endif %}">
                Otros
            </button>
        </div>
    </div>

    {% if query %}
    <div class="search-results-info">
        <p>Resultados para: "<strong>{{ query }}</strong>"</p>
        <a href="{% url 'home' %}" class="clear-search-link">Ver todos los productos</a>
    </div>
    {% endif %}
    <!-- GRID DE PRODUCTOS -->
    <div class="grid-productos" id="productosContainer">
        {% for p in productos %}
        <div class="card"
             data-categoria="{{ p.categoria }}"
             data-nombre="{{ p.titulo|lower }}"
             onclick="abrirProducto({{ p.id }})">

            <div class="card-image">
                <img src="{{ p.imagen.url }}"
                     class="img-producto"
                     alt="{{ p.titulo }}"
                     onerror="this.src='{% static 'img/no-image.png' %}'">

                {% if p.descuento_activo %}
                <div class="badge-descuento">-{{ p.porcentaje_descuento }}%</div>
                {% endif %}
            </div>

            <div class="card-content">
                <h3>{{ p.titulo }}</h3>

                <div class="card-pricing">
                    {% if p.descuento_activo %}
                    <div class="pricing-with-discount">
                        <div class="original-price">${{ p.precio }}</div>
                        <div class="current-price">${{ p.precio_con_descuento }}</div>
                    </div>
                    {% else %}
                    <div class="normal-price">${{ p.precio }}</div>
                    {% endif %}

                    <div class="product-unit">
                        <span class="unit-badge">{{ p.get_unidad_display }}</span>
                    </div>
                </div>

                <!-- Botón carrito (se mantiene, no interfiere con onclick del modal) -->
                <button onclick="event.stopPropagation(); agregarAlCarrito({{ p.id }}, '{{ p.titulo|escapejs }}', {{ p.precio_con_descuento }})"
                        class="add-to-cart-btn">
                    <i class="fas fa-cart-plus"></i> Agregar al Carrito
                </button>
            </div>

        </div>
        {% empty %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-box-open"></i>
            </div>
            <p>No hay productos disponibles{% if query %} que coincidan con tu búsqueda{% endif %}.</p>

            {% if query %}
            <a href="{% url 'home' %}" class="btn-save">Ver todos los productos</a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- PAGINACIÓN -->
    {% if productos.paginator.num_pages > 1 %}
    <div class="pagination shop-pagination">
        <div class="pagination-info">
            Página {{ productos.number }} de {{ productos.paginator.num_pages }}
        </div>

        <div class="pagination-controls">
            {% if productos.has_previous %}
            <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}" class="pagination-btn">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ productos.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}" class="pagination-btn">
                <i class="fas fa-angle-left"></i>
            </a>
            {% else %}
            <span class="pagination-btn disabled"><i class="fas fa-angle-double-left"></i></span>
            <span class="pagination-btn disabled"><i class="fas fa-angle-left"></i></span>
            {% endif %}

            <div class="pagination-numbers">
                {% for num in productos.paginator.page_range %}
                    {% if productos.number == num %}
                    <span class="pagination-number active">{{ num }}</span>
                    {% elif num > productos.number|add:'-3' and num < productos.number|add:'3' %}
                    <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}" class="pagination-number">{{ num }}</a>
                    {% endif %}
                {% endfor %}
            </div>

            {% if productos.has_next %}
            <a href="?page={{ productos.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}" class="pagination-btn">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ productos.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if categoria_actual %}&categoria={{ categoria_actual }}{% endif %}" class="pagination-btn">
                <i class="fas fa-angle-double-right"></i>
            </a>
            {% else %}
            <span class="pagination-btn disabled"><i class="fas fa-angle-right"></i></span>
            <span class="pagination-btn disabled"><i class="fas fa-angle-double-right"></i></span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- MODAL DEL CARRITO -->
    <div id="modalCarrito" class="modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><i class="fas fa-shopping-cart"></i> Tu Carrito</h2>
                <button class="btn-cerrar" onclick="cerrarCarrito()"><i class="fas fa-times"></i></button>
            </div>

            <div id="listaCarrito" class="lista-carrito">
                <!-- Items del carrito -->
            </div>

            <div class="total-carrito">
                <span class="total-label">Total:</span>
                <span id="totalCarrito" class="total-amount">$0</span>
            </div>

            <div class="modal-footer">
                <button class="btn-send"><i class="fas fa-truck"></i> Completar Datos de Envío</button>
                <button class="btn-cancelar" onclick="cerrarCarrito()">Seguir Comprando</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLE PRODUCTO -->
    <div id="modalProducto" class="modal">
        <div class="modal-content" onclick="event.stopPropagation()">

            <div class="modal-header">
                <h2 id="modalProductoTitulo"></h2>
                <button class="btn-cerrar" onclick="cerrarProducto()"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-product-body">
                <img id="modalProductoImagen" class="modal-product-img" src="" alt="Producto">

                <p id="modalProductoDescripcion" class="modal-product-description"></p>

                <div class="modal-product-pricing">
                    <span id="modalProductoPrecio" class="modal-product-price"></span>
                    <span id="modalProductoUnidad" class="modal-product-unit"></span>
                </div>

                <!-- Selector de cantidad -->
                <div class="modal-cantidad-wrapper">
                    <label for="modalProductoCantidad">Cantidad:</label>
                    <input id="modalProductoCantidad" type="number" min="1" value="1000" step="50">
                    <span id="modalUnidadTexto">g</span>
                </div>

                <!-- Botón agregar -->
                <button id="modalProductoAgregar"
                        class="btn-cart"
                        onclick="">
                    <i class="fas fa-cart-plus"></i> Agregar al Carrito
                </button>
            </div>

        </div>
    </div>
    <script src="{% static 'js/app.js' %}"></script>

    <script>
        /* =========================================================
           INICIALIZACIÓN GENERAL
        ========================================================= */
        document.addEventListener('DOMContentLoaded', function() {

            // Botón abrir carrito
            document.getElementById('btnAbrirCarrito')
                .addEventListener('click', abrirCarrito);

            // Inicializar carrito desde localStorage
            actualizarContador();

            // Cerrar modal al hacer clic fuera
            document.getElementById('modalCarrito')
                .addEventListener('click', function(e) {
                    if (e.target === this) cerrarCarrito();
                });

            // Cerrar modal producto al hacer clic fuera
            document.getElementById('modalProducto')
                .addEventListener('click', function(e) {
                    if (e.target === this) cerrarProducto();
                });

            setupFilters();
            initCarousel();
        });

        /* =========================================================
           FILTROS
        ========================================================= */
        function setupFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoria = urlParams.get('categoria');

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (categoria) {
                const activeBtn = document.querySelector(`.filter-btn[onclick*="${categoria}"]`);
                if (activeBtn) activeBtn.classList.add('active');
            } else {
                const allBtn = document.querySelector('.filter-btn[onclick*="todas"]');
                if (allBtn) allBtn.classList.add('active');
            }
        }

        function filtrar(categoria) {
            const url = new URL(window.location);

            if (categoria === 'todas') {
                url.searchParams.delete('categoria');
            } else {
                url.searchParams.set('categoria', categoria);
            }

            const searchInput = document.getElementById('searchInput');
            if (searchInput.value) {
                url.searchParams.set('q', searchInput.value);
            }

            window.location.href = url.toString();
        }

        /* =========================================================
           CARRUSEL DE DESCUENTOS
        ========================================================= */

        let currentSlide = 0;
        const slidesToShow = 4;

        function initCarousel() {
            const track = document.getElementById('carruselTrack');
            if (!track) return;

            const slides = track.children;
            const total = slides.length;

            const dotsContainer = document.getElementById('carruselDots');
            if (dotsContainer) {
                dotsContainer.innerHTML = "";
                for (let i = 0; i < Math.ceil(total / slidesToShow); i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    if (i === 0) dot.classList.add('active');
                    dot.addEventListener('click', () => goToSlide(i));
                    dotsContainer.appendChild(dot);
                }
            }
        }

        function moveCarousel(direction) {
            const track = document.getElementById('carruselTrack');
            const slides = track.children;

            const totalGroups = Math.ceil(slides.length / slidesToShow);

            currentSlide += direction;

            if (currentSlide < 0) currentSlide = totalGroups - 1;
            if (currentSlide >= totalGroups) currentSlide = 0;

            track.style.transform = `translateX(-${currentSlide * 100}%)`;

            updateDots();
        }

        function goToSlide(slideIndex) {
            currentSlide = slideIndex;
            const track = document.getElementById('carruselTrack');
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            updateDots();
        }

        function updateDots() {
            const dots = document.querySelectorAll('#carruselDots .dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
        }

        /* =========================================================
           MODAL DE PRODUCTO
        ========================================================= */
        function abrirProducto(id) {

            fetch(`/api/producto/${id}/`)
                .then(res => res.json())
                .then(p => {

                    document.getElementById('modalProductoTitulo').textContent = p.titulo;
                    document.getElementById('modalProductoImagen').src = p.imagen;
                    document.getElementById('modalProductoDescripcion').textContent = p.descripcion;
                    document.getElementById('modalProductoPrecio').textContent = "$" + p.precio_final;
                    document.getElementById('modalProductoUnidad').textContent = p.unidad_display;

                    // Selector de cantidad
                    const select = document.getElementById('modalProductoCantidad');
                    select.innerHTML = "";

                    if (p.fraccionado && p.unidad === "kg") {
                        select.innerHTML += `<option value="0.25">¼ kg</option>`;
                        select.innerHTML += `<option value="0.5">½ kg</option>`;
                        select.innerHTML += `<option value="1">1 kg</option>`;
                        select.innerHTML += `<option value="2">2 kg</option>`;
                    } else {
                        select.innerHTML += `<option value="1">1</option>`;
                        select.innerHTML += `<option value="2">2</option>`;
                        select.innerHTML += `<option value="3">3</option>`;
                    }

                    // Setup handler agregar al carrito
                    document.getElementById('modalProductoAgregar').onclick = function() {
                        agregarAlCarrito(p.id, p.titulo, p.precio_final, select.value);
                    };

                    // Mostrar modal
                    document.getElementById('modalProducto').style.display = "flex";
                });
        }

        function cerrarProducto() {
            document.getElementById('modalProducto').style.display = "none";
        }

    </script>

</body>
</html>
